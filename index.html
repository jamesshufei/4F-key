<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加密通訊與雜湊展示 (響應式優化版)</title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 引入 Babel 用於解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 自定義動畫樣式 -->
    <style>
        @keyframes slide-right {
            0% { transform: translateX(0); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateX(200px); opacity: 0; }
        }
        @keyframes slide-left {
            0% { transform: translateX(0); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateX(-200px); opacity: 0; }
        }
        
        /* 桌面版動畫 */
        @media (min-width: 768px) {
            .animate-exchange-forward {
                animation: slide-right 2s ease-in-out forwards;
            }
            .animate-exchange-backward {
                animation: slide-left 2s ease-in-out forwards;
            }
        }

        /* 手機版動畫 (垂直) */
        @media (max-width: 767px) {
            @keyframes slide-down {
                0% { transform: translateY(0); opacity: 0; }
                20% { opacity: 1; }
                80% { opacity: 1; }
                100% { transform: translateY(180px); opacity: 0; }
            }
            @keyframes slide-up {
                0% { transform: translateY(0); opacity: 0; }
                20% { opacity: 1; }
                80% { opacity: 1; }
                100% { transform: translateY(-180px); opacity: 0; }
            }
            .animate-exchange-forward {
                animation: slide-down 2s ease-in-out forwards;
            }
            .animate-exchange-backward {
                animation: slide-up 2s ease-in-out forwards;
            }
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .animate-bounce-in {
            animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* 自定義捲軸樣式 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="bg-gray-100 overflow-hidden"> <!-- 防止 Body 捲動 -->
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icon Components ---
        const IconBase = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        // --- New Distinct Key Icons ---
        const PrivateKeyIcon = (props) => (
            <IconBase {...props}>
                <path d="M12 2a5 5 0 0 0-5 5c0 2 1.5 4 4 4.8V22h2v-3h2v-2h-2v-5.2c2.5-.8 4-2.8 4-4.8a5 5 0 0 0-5-5z"/>
                <circle cx="12" cy="7" r="2" />
            </IconBase>
        );

        const PublicKeyIcon = (props) => (
            <IconBase {...props}>
                <rect x="8" y="2" width="8" height="8" rx="1" />
                <path d="M12 10v12" />
                <path d="M12 18h2" />
                <path d="M12 15h2" />
                <circle cx="12" cy="6" r="1.5" />
            </IconBase>
        );

        const SharedKeyIcon = (props) => (
            <IconBase {...props}>
                <path d="M12 2l4 4-4 4-4-4 4-4z" />
                <path d="M12 10v12" />
                <path d="M12 18h-2" />
                <path d="M12 18h2" />
                <path d="M12 14h-2" />
                <path d="M12 14h2" />
            </IconBase>
        );

        const Lock = (props) => <IconBase {...props}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>;
        const ArrowRight = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const ShieldCheck = (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></IconBase>;
        const Hash = (props) => <IconBase {...props}><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></IconBase>;
        const Server = (props) => <IconBase {...props}><rect width="20" height="8" x="2" y="2" rx="2" ry="2"/><rect width="20" height="8" x="2" y="14" rx="2" ry="2"/><line x1="6" x2="6.01" y1="6" y2="6"/><line x1="6" x2="6.01" y1="18" y2="18"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const PenTool = (props) => <IconBase {...props}><path d="m12 19 7-7 3 3-7 7-3-3z"/><path d="m18 13-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="m2 2 7.586 7.586"/><circle cx="11" cy="11" r="2"/></IconBase>;
        const FileBadge = (props) => <IconBase {...props}><path d="M12 15h.01"/><path d="M7.8 15a2.5 2.5 0 1 1 5.657 3.292c-.313.385-.694.71-1.127.962"/><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></IconBase>;
        const ChevronLeft = (props) => <IconBase {...props}><path d="m15 18-6-6 6-6"/></IconBase>;
        const Eye = (props) => <IconBase {...props}><path d="M2 12s3-7 10-7 10 7 10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;
        const Sparkles = (props) => <IconBase {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></IconBase>;

        // --- Main Component ---
        const SecureCommunicationDemo = () => {
          const [mode, setMode] = useState('menu');
          const [step, setStep] = useState(0);
          const [message, setMessage] = useState("");
          const [isAnimating, setIsAnimating] = useState(false);

          // 自動捲動到底部，確保新內容可見
          const contentRef = React.useRef(null);
          useEffect(() => {
            if (contentRef.current) {
                contentRef.current.scrollTop = contentRef.current.scrollHeight;
            }
          }, [step, mode]);

          // Constants for colors
          const aliceColor = "text-emerald-600";
          const bobColor = "text-blue-600";
          const sharedColor = "text-orange-500";
          const saltColor = "text-pink-500";

          // Scenario Data
          const scenarios = {
            encryption: {
              id: 'encryption',
              title: "非對稱加密 (Asymmetric)",
              subtitle: "保密性 (Confidentiality)",
              color: "blue",
              icon: <Lock className="w-6 h-6" />,
              defaultMessage: "機密合約內容：專案X啟動",
              steps: [
                { title: "場景初始化", desc: "雙方準備通訊。目標是「保密」，防止竊聽。使用公鑰/私鑰對。" },
                { title: "步驟 1: 生成金鑰對", desc: "雙方各自生成「公開金鑰」與「秘密金鑰」。請注意它們外觀的不同。" },
                { title: "步驟 2: 交換公開金鑰", desc: "Alice 取得 Bob 的公鑰。她需要用這把鑰匙來鎖住訊息。" },
                { title: "步驟 3: 撰寫訊息與雜湊", desc: "Alice 寫下機密訊息，並計算雜湊值以確保完整性。" },
                { title: "步驟 4: 產生 MAC", desc: "Alice 用自己的私鑰加密雜湊值，生成訊息鑑別碼 (MAC)，證明來源。" },
                { title: "步驟 5: 加密訊息 (封包)", desc: "關鍵步驟：Alice 使用 Bob 的「公開金鑰」將整個包裹加密。只有 Bob 能解開。" },
                { title: "步驟 6: 傳送密文", desc: "加密包裹在網路上傳輸。即使被攔截，駭客也無法看到內容。" },
                { title: "步驟 7: 解密密文", desc: "Bob 收到後，使用自己的「秘密金鑰」解開包裹，還原訊息。" },
                { title: "步驟 8: 驗證來源", desc: "Bob 驗證 MAC。確認訊息未被竄改，且確實來自 Alice。" }
              ]
            },
            signature: {
              id: 'signature',
              title: "數位簽章 (Digital Signature)",
              subtitle: "真實性 (Authenticity)",
              color: "purple",
              icon: <FileBadge className="w-6 h-6" />,
              defaultMessage: "公開聲明：我同意支付 100 單位",
              steps: [
                { title: "場景初始化", desc: "雙方準備通訊。目標是「防竄改」與「不可否認」，內容通常是公開的。" },
                { title: "步驟 1: 生成金鑰對", desc: "雙方各自生成金鑰對。數位簽章的核心在於發送者的私鑰。" },
                { title: "步驟 2: 交換公開金鑰", desc: "Bob 取得 Alice 的公鑰。他需要這把鑰匙來驗證簽章。" },
                { title: "步驟 3: 撰寫文件與雜湊", desc: "Alice 擬定一份公開文件，並計算其雜湊值（數位指紋）。" },
                { title: "步驟 4: 製作數位簽章", desc: "關鍵步驟：Alice 使用自己的「秘密金鑰」加密雜湊值，生成「數位簽章」。" },
                { title: "步驟 5: 附加簽章", desc: "Alice 將「原始文件」與「數位簽章」釘在一起。內容保持明文。" },
                { title: "步驟 6: 傳送文件", desc: "文件在網路上傳輸。大眾可見內容，但無法偽造 Alice 的簽名。" },
                { title: "步驟 7: 接收文件", desc: "Bob 收到文件與簽章。此時他還不確定文件是否被竄改過。" },
                { title: "步驟 8: 驗證簽章", desc: "Bob 使用 Alice 的「公開金鑰」解開簽章，並與文件雜湊比對。一致即驗證成功！" }
              ]
            },
            symmetric: {
              id: 'symmetric',
              title: "對稱式加密 (Symmetric)",
              subtitle: "效率與共享 (Efficiency)",
              color: "orange",
              icon: <RefreshCw className="w-6 h-6" />,
              defaultMessage: "最高機密：核對代碼 7788",
              steps: [
                { title: "場景初始化", desc: "目標是快速通訊。雙方將使用「同一把金鑰」進行加解密。" },
                { title: "步驟 1: 生成共用金鑰", desc: "Alice 生成一把「共用金鑰 (Shared Key)」。這把鑰匙既能上鎖也能開鎖。" },
                { title: "步驟 2: 傳遞金鑰 (風險)", desc: "關鍵風險：Alice 必須透過「安全管道」將這把金鑰傳給 Bob。若此時被竊，通訊全毀。" },
                { title: "步驟 3: 撰寫訊息", desc: "Alice 寫下機密訊息。此時訊息還是明文。" },
                { title: "步驟 4: 加密訊息", desc: "Alice 使用這把「共用金鑰」將訊息上鎖。運算速度快，適合大量資料。" },
                { title: "步驟 5: 傳送密文", desc: "加密後的包裹在網路上傳輸。沒有這把特定鑰匙的人無法開啟。" },
                { title: "步驟 6: 接收密文", desc: "Bob 收到密文包裹。他需要使用剛剛收到的那把鑰匙。" },
                { title: "步驟 7: 解密訊息", desc: "Bob 使用手上的「共用金鑰」解開包裹，讀取訊息。" },
                { title: "步驟 8: 通訊完成", desc: "雙方成功透過單一金鑰完成保密通訊。" }
              ]
            },
            hashing: {
              id: 'hashing',
              title: "雜湊加鹽 (Hashing & Salt)",
              subtitle: "完整性與防護 (Integrity)",
              color: "pink",
              icon: <Hash className="w-6 h-6" />,
              defaultMessage: "UserPassword123",
              steps: [
                { title: "場景初始化", desc: "目標是安全儲存或傳遞資料。如果不加鹽(Unsalted)，相同的輸入永遠產生相同的雜湊，容易被「彩虹表」破解。" },
                { title: "步驟 1: 生成隨機鹽 (Salt)", desc: "Alice 生成一個隨機數值「鹽」。這不是秘密金鑰，但能讓雜湊結果變得獨一無二。" },
                { title: "步驟 2: 準備訊息", desc: "Alice 準備好要雜湊的訊息（例如密碼或文件）。" },
                { title: "步驟 3: 混合訊息與鹽", desc: "關鍵步驟：將「訊息」與「鹽」組合在一起。 Input = Message + Salt。" },
                { title: "步驟 4: 計算雜湊值", desc: "通過雜湊函數運算。即使原本是常見密碼，加上鹽後也會變成完全不同的亂碼。" },
                { title: "步驟 5: 傳送資料包", desc: "Alice 將「訊息(或ID)」、「鹽」與「雜湊值」傳送給 Bob (Server)。注意：鹽通常是公開傳遞的。" },
                { title: "步驟 6: 接收資料", desc: "Bob 收到資料。他擁有訊息(或從資料庫調出)、鹽以及 Alice 傳來的雜湊值。" },
                { title: "步驟 7: 重新計算", desc: "Bob 使用收到的「訊息」加上收到的「鹽」，跑一次相同的雜湊函數。" },
                { title: "步驟 8: 比對驗證", desc: "比對計算結果與收到的雜湊值。一致則證明資料正確且未被竄改。" }
              ]
            }
          };

          const currentScenario = mode === 'menu' ? null : scenarios[mode];

          const startScenario = (selectedMode) => {
            setMode(selectedMode);
            setStep(0);
            setMessage(scenarios[selectedMode].defaultMessage);
          };

          const nextStep = () => {
            if (currentScenario && step < currentScenario.steps.length - 1) {
              setIsAnimating(true);
              setTimeout(() => setIsAnimating(false), 1000);
              setStep(step + 1);
            }
          };

          const reset = () => {
            setStep(0);
            setIsAnimating(false);
          };

          const goBack = () => {
            setMode('menu');
            setStep(0);
          };

          const KeyIcon = ({ type, owner, className = "" }) => {
            let keyColorClass = "";
            let label = "";
            let IconComp = PublicKeyIcon;
            
            if (type === 'private') {
              keyColorClass = "text-red-500";
              label = "私鑰";
              IconComp = PrivateKeyIcon; 
            } else if (type === 'public') {
              keyColorClass = owner === 'alice' ? aliceColor : bobColor;
              label = "公鑰";
              IconComp = PublicKeyIcon; 
            } else if (type === 'shared') {
              keyColorClass = sharedColor;
              label = "共用金鑰";
              IconComp = SharedKeyIcon; 
            } else if (type === 'salt') {
              keyColorClass = saltColor;
              label = "隨機鹽(Salt)";
              IconComp = Sparkles;
            }

            return (
              <div className={`flex flex-col items-center p-2 rounded-lg border-2 bg-white/80 backdrop-blur-sm shadow-sm ${className} ${owner === 'alice' ? 'border-emerald-200' : (owner === 'bob' ? 'border-blue-200' : 'border-pink-200')}`}>
                <IconComp className={`w-6 h-6 ${keyColorClass}`} />
                <span className="text-[10px] font-bold mt-1 text-gray-600">{label}</span>
                {owner && type !== 'salt' && <span className="text-[9px] text-gray-400 uppercase">{owner}</span>}
              </div>
            );
          };

          const getHeaderBg = () => {
            if (mode === 'encryption') return 'bg-blue-900';
            if (mode === 'signature') return 'bg-indigo-900';
            if (mode === 'symmetric') return 'bg-orange-900';
            if (mode === 'hashing') return 'bg-pink-900';
            return 'bg-slate-900';
          };

          const getProgressColor = () => {
            if (mode === 'encryption') return 'bg-blue-500';
            if (mode === 'signature') return 'bg-purple-500';
            if (mode === 'symmetric') return 'bg-orange-500';
            if (mode === 'hashing') return 'bg-pink-500';
            return 'bg-gray-500';
          };

          // --- MENU VIEW (Scrollable) ---
          if (mode === 'menu') {
            return (
              <div className="h-screen bg-gradient-to-br from-slate-100 to-slate-200 p-2 md:p-4 flex items-center justify-center font-sans text-slate-800">
                <div className="max-w-5xl w-full bg-white shadow-2xl rounded-3xl overflow-hidden flex flex-col h-full md:h-[90vh]">
                  <div className="bg-slate-900 text-white p-6 text-center shrink-0">
                    <ShieldCheck className="w-12 h-12 md:w-16 md:h-16 text-emerald-400 mx-auto mb-2 md:mb-4" />
                    <h1 className="text-2xl md:text-3xl font-bold mb-2">密碼學應用實例展示</h1>
                    <p className="text-slate-400 text-sm md:text-base">請選擇您想要模擬的應用場景</p>
                  </div>
                  
                  <div className="p-4 md:p-6 overflow-y-auto custom-scrollbar grow">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                      {/* Menu Buttons (same content, responsive tweaks) */}
                      <button 
                        onClick={() => startScenario('encryption')}
                        className="group p-4 md:p-6 border-2 border-blue-100 bg-white rounded-2xl hover:border-blue-500 hover:shadow-xl hover:bg-blue-50 transition-all text-left relative overflow-hidden flex flex-col"
                      >
                        <div className="flex items-center gap-3 mb-3">
                          <div className="p-3 bg-blue-100 rounded-lg text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition-colors">
                            <Lock className="w-6 h-6" />
                          </div>
                          <h2 className="text-lg font-bold text-slate-800">非對稱加密</h2>
                        </div>
                        <p className="text-xs text-blue-600 font-bold mb-2 uppercase tracking-wider">Confidentiality</p>
                        <p className="text-sm text-slate-600 mb-2">使用接收者的公鑰加密。確保只有接收者能解讀訊息。</p>
                      </button>

                      <button 
                        onClick={() => startScenario('signature')}
                        className="group p-4 md:p-6 border-2 border-purple-100 bg-white rounded-2xl hover:border-purple-500 hover:shadow-xl hover:bg-purple-50 transition-all text-left relative overflow-hidden flex flex-col"
                      >
                        <div className="flex items-center gap-3 mb-3">
                          <div className="p-3 bg-purple-100 rounded-lg text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition-colors">
                            <FileBadge className="w-6 h-6" />
                          </div>
                          <h2 className="text-lg font-bold text-slate-800">數位簽章</h2>
                        </div>
                        <p className="text-xs text-purple-600 font-bold mb-2 uppercase tracking-wider">Authenticity</p>
                        <p className="text-sm text-slate-600 mb-2">使用發送者的私鑰簽署。確保訊息確實來自發送者且未被竄改。</p>
                      </button>

                      <button 
                        onClick={() => startScenario('symmetric')}
                        className="group p-4 md:p-6 border-2 border-orange-100 bg-white rounded-2xl hover:border-orange-500 hover:shadow-xl hover:bg-orange-50 transition-all text-left relative overflow-hidden flex flex-col"
                      >
                        <div className="flex items-center gap-3 mb-3">
                          <div className="p-3 bg-orange-100 rounded-lg text-orange-600 group-hover:bg-orange-600 group-hover:text-white transition-colors">
                            <RefreshCw className="w-6 h-6" />
                          </div>
                          <h2 className="text-lg font-bold text-slate-800">對稱式加密</h2>
                        </div>
                        <p className="text-xs text-orange-600 font-bold mb-2 uppercase tracking-wider">Shared Key</p>
                        <p className="text-sm text-slate-600 mb-2">雙方持有相同的「共用金鑰」。速度快，適合大量資料加密。</p>
                      </button>

                      <button 
                        onClick={() => startScenario('hashing')}
                        className="group p-4 md:p-6 border-2 border-pink-100 bg-white rounded-2xl hover:border-pink-500 hover:shadow-xl hover:bg-pink-50 transition-all text-left relative overflow-hidden flex flex-col"
                      >
                        <div className="flex items-center gap-3 mb-3">
                          <div className="p-3 bg-pink-100 rounded-lg text-pink-600 group-hover:bg-pink-600 group-hover:text-white transition-colors">
                            <Hash className="w-6 h-6" />
                          </div>
                          <h2 className="text-lg font-bold text-slate-800">雜湊與加鹽</h2>
                        </div>
                        <p className="text-xs text-pink-600 font-bold mb-2 uppercase tracking-wider">Hashing & Salt</p>
                        <p className="text-sm text-slate-600 mb-2">展示有加鹽(Salted)與無加鹽的差異。防止彩虹表攻擊，確保唯一性。</p>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          // --- SCENARIO VIEW (Fixed Header/Footer, Scrollable Body) ---
          return (
            <div className="h-screen bg-gray-50 p-2 md:p-4 font-sans text-slate-800 flex flex-col items-center">
              <div className="max-w-6xl w-full bg-white shadow-xl rounded-2xl overflow-hidden flex flex-col h-full md:h-[95vh] border border-gray-200">
                
                {/* Header: Fixed */}
                <div className={`text-white p-3 md:p-5 flex justify-between items-center shrink-0 transition-colors duration-500 ${getHeaderBg()}`}>
                  <div className="flex items-center gap-2 md:gap-4">
                    <button onClick={goBack} className="p-2 hover:bg-white/10 rounded-full transition-colors">
                      <ChevronLeft className="w-5 h-5 md:w-6 md:h-6" />
                    </button>
                    <div>
                      <h1 className="text-base md:text-2xl font-bold flex items-center gap-2">
                        {currentScenario.icon}
                        {currentScenario.title}
                      </h1>
                      <p className="text-slate-300 text-xs md:text-sm mt-0.5 opacity-80 hidden md:block">{currentScenario.steps[step].title}</p>
                    </div>
                  </div>
                  <div className="text-right">
                     <span className="bg-white/20 px-2 py-1 md:px-3 rounded-full text-[10px] md:text-xs font-mono backdrop-blur-sm whitespace-nowrap">
                       Step {step} / {currentScenario.steps.length - 1}
                     </span>
                  </div>
                </div>

                {/* Progress Bar: Fixed */}
                <div className="w-full bg-gray-200 h-1 md:h-1.5 shrink-0">
                  <div 
                    className={`h-full transition-all duration-500 ${getProgressColor()}`}
                    style={{ width: `${(step / (currentScenario.steps.length - 1)) * 100}%` }}
                  ></div>
                </div>

                {/* Main Content: Scrollable */}
                <div 
                  ref={contentRef}
                  className="flex-1 p-2 md:p-6 bg-slate-50 relative overflow-y-auto custom-scrollbar"
                >
                  
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-8 relative min-h-[400px]">
                    
                    {/* ALICE SIDE */}
                    <div className={`relative border-2 border-dashed rounded-xl p-3 md:p-6 transition-all duration-500 ${step >= 1 ? 'border-emerald-300 bg-white shadow-lg' : 'border-gray-300 opacity-50'}`}>
                      <div className="flex items-center gap-3 mb-4 md:mb-6 border-b pb-3 sticky top-0 bg-white/95 backdrop-blur z-30">
                        <div className="w-8 h-8 md:w-12 md:h-12 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-700 font-bold text-base md:text-xl shadow-sm">A</div>
                        <div>
                          <h2 className="text-base md:text-lg font-bold text-emerald-800">發送端 (Alice)</h2>
                          <div className="text-[10px] text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded-full inline-block">發起者</div>
                        </div>
                      </div>

                      <div className="space-y-4">
                        {step >= 1 && (
                          <div className="flex gap-2 justify-center animate-fade-in-up flex-wrap">
                            {(mode === 'encryption' || mode === 'signature') && (
                              <>
                                <KeyIcon type="public" owner="alice" />
                                <KeyIcon type="private" owner="alice" />
                              </>
                            )}
                            
                            {mode === 'symmetric' && (
                               <KeyIcon type="shared" owner="alice" className="border-orange-200 bg-orange-50 text-orange-600" />
                            )}

                            {mode === 'hashing' && (
                               <KeyIcon type="salt" className="border-pink-200 bg-pink-50 text-pink-600" />
                            )}

                            {step >= 2 && mode === 'encryption' && (
                              <div className="transition-opacity duration-500">
                                 <KeyIcon type="public" owner="bob" className="border-blue-200 bg-blue-50" />
                              </div>
                            )}
                          </div>
                        )}

                        {step >= (mode === 'hashing' ? 2 : 3) && (
                          <div className="animate-fade-in-up group relative">
                            <div className={`absolute -inset-0.5 rounded-lg blur opacity-30 ${mode === 'signature' ? 'bg-white' : (mode === 'hashing' ? 'bg-pink-400' : 'bg-yellow-400')}`}></div>
                            <div className={`relative border p-3 rounded-lg shadow-sm ${mode === 'hashing' ? 'bg-pink-50 border-pink-200' : 'bg-yellow-50 border-yellow-200'}`}>
                              <div className={`flex items-center gap-2 mb-2 ${mode === 'hashing' ? 'text-pink-800' : 'text-yellow-800'}`}>
                                {mode === 'signature' ? <PenTool className="w-4 h-4" /> : <FileText className="w-4 h-4" />}
                                <span className="text-xs font-bold">{mode === 'hashing' ? '輸入資料 (Data)' : (mode === 'signature' ? '公開文件 (M)' : '原始訊息 (M)')}</span>
                              </div>
                              {step === (mode === 'hashing' ? 2 : 3) ? (
                                <input 
                                  type="text" 
                                  value={message} 
                                  onChange={(e) => setMessage(e.target.value)}
                                  className={`w-full text-sm border-b bg-transparent focus:outline-none transition-colors ${mode === 'hashing' ? 'border-pink-300 focus:border-pink-500' : 'border-yellow-300 focus:border-yellow-500'}`}
                                />
                              ) : (
                                <div className="text-sm text-gray-700 truncate font-mono bg-white/50 p-1 rounded">{message}</div>
                              )}
                            </div>
                          </div>
                        )}

                        {step >= (mode === 'hashing' ? 3 : 4) && (
                           <React.Fragment>
                            {(mode === 'encryption' || mode === 'signature') && (
                              <div className={`border p-3 rounded-lg animate-fade-in-up relative overflow-hidden shadow-sm ${mode === 'encryption' ? 'bg-blue-50 border-blue-200' : 'bg-purple-50 border-purple-200'}`}>
                                <div className={`flex items-center gap-2 mb-2 ${mode === 'encryption' ? 'text-blue-800' : 'text-purple-800'}`}>
                                  <Hash className="w-4 h-4" />
                                  <span className="text-xs font-bold">資料處理工廠</span>
                                </div>
                                
                                <div className="flex flex-col gap-2 items-center">
                                  <div className="text-[10px] bg-white px-3 py-1 rounded border shadow-sm font-mono">Hash(M) = H</div>
                                  <div className={`h-3 w-[1px] ${mode === 'encryption' ? 'bg-blue-300' : 'bg-purple-300'}`}></div>
                                  
                                  <div className="flex items-center gap-2 bg-white px-3 py-1.5 rounded border shadow-sm">
                                    <PrivateKeyIcon className="w-3 h-3 text-red-500" /> 
                                    <span className="text-[10px] font-bold">Alice 私鑰{mode === 'encryption' ? '加密(H)' : '簽署(H)'}</span>
                                  </div>
                                  <div className={`h-3 w-[1px] ${mode === 'encryption' ? 'bg-blue-300' : 'bg-purple-300'}`}></div>
                                  
                                  <div className={`text-white text-[10px] px-3 py-1 rounded-full font-bold shadow-sm ${mode === 'encryption' ? 'bg-blue-500' : 'bg-purple-500'}`}>
                                    {mode === 'encryption' ? 'MAC (鑑別碼)' : 'Digital Signature (數位簽章)'}
                                  </div>
                                </div>
                              </div>
                            )}

                            {mode === 'symmetric' && (
                              <div className="bg-orange-50 border border-orange-200 p-3 rounded-lg animate-fade-in-up shadow-sm">
                                <div className="flex items-center gap-2 text-orange-800 mb-2">
                                  <Lock className="w-4 h-4" />
                                  <span className="text-xs font-bold">對稱加密中...</span>
                                </div>
                                <div className="flex justify-center items-center gap-2">
                                  <span className="text-xs">訊息 M</span>
                                  <span className="text-lg">+</span>
                                  <SharedKeyIcon className="w-4 h-4 text-orange-500" />
                                  <span className="text-xs">(共用金鑰)</span>
                                  <ArrowRight className="w-4 h-4" />
                                  <Lock className="w-4 h-4 text-orange-600" />
                                </div>
                              </div>
                            )}

                            {mode === 'hashing' && step >= 3 && (
                              <div className="bg-pink-50 border border-pink-200 p-3 rounded-lg animate-fade-in-up shadow-sm">
                                 <div className="flex items-center gap-2 text-pink-800 mb-2">
                                   <Hash className="w-4 h-4" />
                                   <span className="text-xs font-bold">雜湊運算 (Hashing)</span>
                                 </div>
                                 <div className="flex flex-col gap-2">
                                   <div className="flex items-center justify-center gap-2 text-[10px]">
                                      <span className="bg-white px-2 py-1 rounded border">Data</span>
                                      <span>+</span>
                                      <div className="flex items-center gap-1 bg-white px-2 py-1 rounded border border-pink-200">
                                        <Sparkles className="w-3 h-3 text-pink-500" />
                                        <span className="text-pink-700 font-bold">Salt</span>
                                      </div>
                                   </div>
                                   {step >= 4 && (
                                     <React.Fragment>
                                       <div className="w-[1px] h-3 bg-pink-300 mx-auto"></div>
                                       <div className="bg-pink-600 text-white text-[10px] px-3 py-1 rounded-full text-center font-mono shadow-sm">
                                         H(Data + Salt) = 8f4a...
                                       </div>
                                     </React.Fragment>
                                   )}
                                 </div>
                              </div>
                            )}
                           </React.Fragment>
                        )}

                        {step >= 5 && step < 7 && (
                           <div className={`mt-4 relative z-20 transition-all duration-1000 transform 
                              ${step === 6 ? 'opacity-0 md:opacity-100 translate-y-[300px] md:translate-y-0 md:translate-x-[160%]' : ''}`}
                           >
                              {mode === 'encryption' && (
                                <div className="border-2 border-blue-600 bg-slate-800 text-white p-4 rounded-xl shadow-2xl relative">
                                   <div className="absolute -top-3 -right-3 bg-blue-600 rounded-full p-2 border-4 border-white shadow-md">
                                    <Lock className="w-5 h-5 text-white" />
                                  </div>
                                  <div className="text-center text-[10px] mb-2 text-blue-200 font-mono">ENCRYPTED WITH BOB'S PUBLIC KEY</div>
                                  <div className="flex gap-2 justify-center opacity-50 grayscale">
                                    <FileText className="w-8 h-8" />
                                  </div>
                                </div>
                              )}

                              {mode === 'symmetric' && (
                                <div className="border-2 border-orange-500 bg-slate-800 text-white p-4 rounded-xl shadow-2xl relative">
                                   <div className="absolute -top-3 -right-3 bg-orange-500 rounded-full p-2 border-4 border-white shadow-md">
                                    <Lock className="w-5 h-5 text-white" />
                                  </div>
                                  <div className="text-center text-[10px] mb-2 text-orange-200 font-mono">LOCKED WITH SHARED KEY</div>
                                  <div className="flex gap-2 justify-center opacity-50 grayscale">
                                    <FileText className="w-8 h-8" />
                                  </div>
                                </div>
                              )}

                              {mode === 'signature' && (
                                <div className="border border-purple-200 bg-white p-2 rounded-xl shadow-2xl relative transform rotate-3 hover:rotate-0 transition-transform">
                                  <div className="absolute -bottom-3 -right-3">
                                     <div className="bg-red-600 text-white rounded-full p-2 border-4 border-white shadow-md flex items-center justify-center w-12 h-12">
                                       <span className="text-[8px] font-serif font-bold italic leading-tight text-center">Alice<br/>Sign</span>
                                     </div>
                                  </div>
                                  <div className="bg-yellow-50 border border-yellow-100 p-3 rounded mb-2">
                                     <div className="h-1 w-1/3 bg-gray-300 mb-1 rounded"></div>
                                     <div className="h-1 w-2/3 bg-gray-300 mb-1 rounded"></div>
                                  </div>
                                  <div className="bg-purple-100 text-purple-800 text-[9px] px-2 py-1 rounded text-center font-bold">
                                    Signature Attached
                                  </div>
                                </div>
                              )}

                              {mode === 'hashing' && (
                                <div className="border border-pink-300 bg-white p-2 rounded-xl shadow-2xl relative">
                                  <div className="bg-pink-50 border border-pink-100 p-2 rounded mb-1 flex items-center justify-center gap-2">
                                     <FileText className="w-4 h-4 text-gray-500" />
                                     <span className="text-[10px]">Data</span>
                                     <span className="text-gray-300">|</span>
                                     <Sparkles className="w-3 h-3 text-pink-500" />
                                     <span className="text-[10px] text-pink-600">Salt</span>
                                  </div>
                                  <div className="bg-slate-800 text-white text-[9px] px-2 py-1 rounded text-center font-mono">
                                    Hash Value: 8f4a...
                                  </div>
                                </div>
                              )}
                           </div>
                        )}
                      </div>
                    </div>

                    {/* CENTER (Network/Transfer) */}
                    <div className="flex flex-col items-center justify-center relative min-h-[60px] md:min-h-auto">
                       <div className="h-full w-[2px] bg-gray-200 absolute z-0 hidden md:block"></div>
                       
                       {step === 2 && (
                        <div className="z-10 w-full h-32 md:h-20 relative">
                           {(mode === 'signature' || mode === 'symmetric') && (
                              <div className="absolute top-0 left-1/2 -translate-x-1/2 md:left-0 md:translate-x-0 animate-exchange-forward flex flex-col items-center">
                                {mode === 'symmetric' ? (
                                    <SharedKeyIcon className="w-8 h-8 drop-shadow-md text-orange-500" />
                                ) : (
                                    <PublicKeyIcon className="w-8 h-8 drop-shadow-md text-emerald-500" />
                                )}
                                <span className="text-[9px] bg-white px-1 border rounded shadow-sm mt-1">{mode === 'symmetric' ? '傳遞共用金鑰' : 'Alice 公鑰'}</span>
                              </div>
                           )}
                           {mode === 'encryption' && (
                              <div className="absolute bottom-0 left-1/2 -translate-x-1/2 md:right-0 md:left-auto md:translate-x-0 animate-exchange-backward flex flex-col items-center">
                                <PublicKeyIcon className="w-8 h-8 text-blue-500 drop-shadow-md" />
                                <span className="text-[9px] bg-white px-1 border rounded shadow-sm mt-1">Bob 公鑰</span>
                              </div>
                           )}
                        </div>
                       )}

                       {step === 6 && (
                        <div className="z-10 bg-white p-2 rounded-full shadow-lg border flex items-center gap-2 animate-pulse md:hidden">
                          <Server className="w-6 h-6 text-gray-400" />
                          <span className="text-xs text-gray-500">傳輸中...</span>
                        </div>
                       )}
                    </div>

                    {/* BOB SIDE */}
                    <div className={`relative border-2 border-dashed rounded-xl p-3 md:p-6 transition-all duration-500 ${step >= 1 ? 'border-blue-300 bg-white shadow-lg' : 'border-gray-300 opacity-50'}`}>
                      <div className="flex items-center gap-3 mb-4 md:mb-6 border-b pb-3 sticky top-0 bg-white/95 backdrop-blur z-30">
                        <div className="w-8 h-8 md:w-12 md:h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-bold text-base md:text-xl shadow-sm">B</div>
                        <div>
                          <h2 className="text-base md:text-lg font-bold text-blue-800">接收端 (Bob)</h2>
                          <div className="text-[10px] text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full inline-block">驗證者</div>
                        </div>
                      </div>

                      <div className="space-y-4">
                         {step >= 1 && (
                          <div className="flex gap-2 justify-center animate-fade-in-up flex-wrap">
                            {(mode === 'encryption' || mode === 'signature') && (
                               <>
                                <KeyIcon type="public" owner="bob" />
                                <KeyIcon type="private" owner="bob" />
                               </>
                            )}

                            {step >= 2 && mode === 'signature' && (
                              <div className="animate-fade-in-up">
                                 <KeyIcon type="public" owner="alice" className="border-emerald-200 bg-emerald-50" />
                              </div>
                            )}
                            {step >= 2 && mode === 'symmetric' && (
                              <div className="animate-fade-in-up">
                                 <KeyIcon type="shared" owner="bob" className="border-orange-200 bg-orange-50 text-orange-600" />
                              </div>
                            )}
                          </div>
                        )}

                        {step >= 7 && (
                          <div className="animate-fade-in-up">
                            <div className="bg-slate-100 border p-3 rounded-md mb-2 opacity-70">
                              <div className="flex items-center gap-2 mb-1">
                                {mode === 'encryption' && (
                                  <React.Fragment>
                                    <Lock className="w-4 h-4 text-blue-500" />
                                    <span className="text-xs font-bold text-blue-600">使用 Bob 私鑰解密...</span>
                                  </React.Fragment>
                                )}
                                {mode === 'symmetric' && (
                                  <React.Fragment>
                                    <Lock className="w-4 h-4 text-orange-500" />
                                    <span className="text-xs font-bold text-orange-600">使用共用金鑰解密...</span>
                                  </React.Fragment>
                                )}
                                {mode === 'signature' && (
                                  <React.Fragment>
                                    <Eye className="w-4 h-4 text-purple-500" />
                                    <span className="text-xs font-bold text-purple-600">收到明文與簽章...</span>
                                  </React.Fragment>
                                )}
                                 {mode === 'hashing' && (
                                  <React.Fragment>
                                    <ArrowRight className="w-4 h-4 text-pink-500" />
                                    <span className="text-xs font-bold text-pink-600">收到資料, 鹽, 雜湊...</span>
                                  </React.Fragment>
                                )}
                              </div>
                            </div>
                            
                            <div className="flex gap-2">
                              <div className="flex-1 bg-yellow-50 border border-yellow-200 p-2 rounded-md shadow-sm">
                                 <div className="flex items-center gap-1 text-yellow-800 mb-1">
                                  {mode === 'signature' ? <PenTool className="w-3 h-3" /> : <FileText className="w-3 h-3" />}
                                  <span className="text-[10px] font-bold">內容 (M)</span>
                                </div>
                                <div className="text-xs truncate font-mono text-gray-600">{message}</div>
                              </div>
                              
                              {mode !== 'symmetric' && mode !== 'hashing' && (
                                <div className={`w-1/3 border p-2 rounded-md flex flex-col items-center justify-center shadow-sm ${mode === 'encryption' ? 'bg-blue-50 border-blue-200' : 'bg-purple-50 border-purple-200'}`}>
                                  <span className={`text-[9px] font-bold ${mode === 'encryption' ? 'text-blue-800' : 'text-purple-800'}`}>
                                    {mode === 'encryption' ? 'MAC' : 'Signature'}
                                  </span>
                                  <CheckCircle className={`w-4 h-4 mt-1 ${mode === 'encryption' ? 'text-blue-400' : 'text-purple-400'}`} />
                                </div>
                              )}

                              {mode === 'hashing' && (
                                <div className="flex flex-col gap-1 w-1/3">
                                  <div className="bg-pink-50 border border-pink-200 p-1 rounded text-center">
                                    <Sparkles className="w-3 h-3 text-pink-500 mx-auto" />
                                    <span className="text-[8px] text-pink-700 font-bold">Salt</span>
                                  </div>
                                   <div className="bg-slate-700 text-white p-1 rounded text-center">
                                    <span className="text-[8px] font-mono">Hash</span>
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                        )}

                        {step >= 8 && (
                          <div className={`mt-4 border-2 p-3 rounded-lg animate-bounce-in shadow-md ${
                            mode === 'symmetric' ? 'bg-orange-50 border-orange-300' : 
                            (mode === 'hashing' ? 'bg-pink-50 border-pink-300' : 'bg-green-50 border-green-400')
                          }`}>
                            <div className={`flex items-center gap-2 mb-2 border-b pb-2 ${
                              mode === 'symmetric' ? 'text-orange-800 border-orange-200' : 
                              (mode === 'hashing' ? 'text-pink-800 border-pink-200' : 'text-green-800 border-green-200')
                            }`}>
                              <ShieldCheck className="w-5 h-5" />
                              <span className="text-sm font-bold">
                                {mode === 'symmetric' ? '解密成功 (Success)' : '驗證成功 (Verified)'}
                              </span>
                            </div>
                            
                            {mode === 'symmetric' ? (
                               <div className="text-xs text-orange-700">
                                 訊息已還原。只要共用金鑰未外洩，通訊就是安全的。
                               </div>
                            ) : mode === 'hashing' ? (
                               <div className="space-y-2 bg-white/50 p-2 rounded">
                                  <div className="flex items-center justify-between text-[10px] text-gray-600">
                                    <span>計算 H(收到的M + 收到的Salt)</span>
                                  </div>
                                  <div className="flex items-center gap-2 text-[10px] text-pink-700 font-bold">
                                     <ArrowRight className="w-3 h-3" />
                                     <span>結果匹配！資料完整。</span>
                                  </div>
                                  <div className="text-[10px] text-gray-500 mt-1 leading-tight">
                                    因為使用了鹽，攻擊者無法使用預先計算的彩虹表來反查原始密碼。
                                  </div>
                               </div>
                            ) : (
                              <div className="space-y-2 bg-white/50 p-2 rounded">
                                <div className="flex items-center justify-between text-[10px] text-gray-600">
                                  <span>1. 計算雜湊 H(M)</span>
                                  <ArrowRight className="w-3 h-3 text-gray-400" />
                                  <span className="font-mono font-bold">Hash_X</span>
                                </div>
                                <div className="flex items-center justify-between text-[10px] text-gray-600">
                                  <span>
                                    2. {mode === 'encryption' ? '私鑰解密 MAC' : 'Alice公鑰解簽章'}
                                  </span>
                                  <ArrowRight className="w-3 h-3 text-gray-400" />
                                  <span className="font-mono font-bold">Hash_X</span>
                                </div>
                                <div className="text-center text-xs font-bold text-green-600 mt-2 bg-green-100 rounded py-1.5 border border-green-200">
                                  {mode === 'encryption' ? '完整性確認！來源確認！' : '簽名有效！文件未被竄改！'}
                                </div>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>

                {/* Footer Controls: Fixed */}
                <div className="bg-white p-3 md:p-6 border-t flex flex-col md:flex-row justify-between items-center gap-3 md:gap-4 shrink-0 shadow-inner z-10">
                  <div className="text-sm text-gray-600 flex-1 w-full md:w-auto">
                     <h3 className="font-bold mb-1 flex items-center gap-2">
                       <span className="w-5 h-5 md:w-6 md:h-6 rounded-full bg-slate-800 text-white flex items-center justify-center text-xs">{step}</span>
                       {currentScenario.steps[step].title}
                     </h3>
                     <p className="text-xs md:text-sm leading-relaxed">{currentScenario.steps[step].desc}</p>
                  </div>

                  <div className="flex gap-3 w-full md:w-auto">
                    <button 
                      onClick={reset}
                      className="flex-1 md:flex-none px-4 py-2 md:py-3 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-medium transition-colors border border-gray-200 md:border-transparent"
                    >
                      重置
                    </button>

                    <button 
                      onClick={nextStep}
                      disabled={step === currentScenario.steps.length - 1}
                      className={`flex-1 md:flex-none flex items-center justify-center gap-2 px-6 py-2 md:py-3 rounded-xl font-bold shadow-lg transition-all transform hover:scale-105 active:scale-95 ${
                        step === currentScenario.steps.length - 1 
                        ? 'bg-gray-200 text-gray-400 cursor-not-allowed shadow-none' 
                        : `${getProgressColor()} text-white hover:opacity-90`
                      }`}
                    >
                      {step === currentScenario.steps.length - 1 ? '完成' : '下一步'}
                      {step < currentScenario.steps.length - 1 && <ArrowRight className="w-4 h-4" />}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SecureCommunicationDemo />);
    </script>
</body>
</html>